<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学习打卡应用</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        /* CSS样式保持不变 */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: #333; line-height: 1.6; padding: 20px; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; background-color: rgba(255, 255, 255, 0.95); border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); padding: 30px; position: relative; overflow: hidden; }
        .container::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 5px; background: linear-gradient(90deg, #6a11cb, #2575fc); }
        h1, h2, h3 { color: #2c3e50; margin-bottom: 20px; }
        h1 { text-align: center; font-size: 2.5rem; margin-bottom: 30px; color: #2575fc; position: relative; }
        h1::after { content: ''; display: block; width: 100px; height: 4px; background: linear-gradient(90deg, #6a11cb, #2575fc); margin: 10px auto; border-radius: 2px; }
        .section { margin-bottom: 40px; padding: 25px; border: 1px solid #e0e0e0; border-radius: 10px; background: white; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); transition: transform 0.3s, box-shadow 0.3s; }
        .section:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input, select, button { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: all 0.3s; }
        input:focus, select:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2); }
        button { background: linear-gradient(135deg, #3498db, #2980b9); color: white; border: none; cursor: pointer; font-weight: 600; letter-spacing: 0.5px; }
        button:hover { background: linear-gradient(135deg, #2980b9, #2575fc); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); }
        button:active { transform: translateY(0); }
        .timer { font-size: 4rem; text-align: center; margin: 30px 0; color: #e74c3c; font-weight: bold; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1); }
        .calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 20px; }
        .calendar-header { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 10px; }
        .calendar-header div { text-align: center; font-weight: bold; color: #2c3e50; padding: 10px; }
        .calendar-day { border: 1px solid #e0e0e0; padding: 12px 5px; text-align: center; min-height: 70px; border-radius: 8px; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.3s; }
        .calendar-day:hover { background-color: #f8f9fa; }
        .calendar-day.checked { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border-color: #27ae60; box-shadow: 0 4px 8px rgba(46, 204, 113, 0.3); }
        .calendar-date { font-size: 14px; font-weight: bold; }
        .calendar-check { font-size: 18px; }
        .admin-section { background-color: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 5px solid #3498db; }
        .hidden { display: none; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); z-index: 1000; transform: translateX(150%); transition: transform 0.5s; }
        .notification.show { transform: translateX(0); }
        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        .user-stats { display: flex; justify-content: space-around; margin: 20px 0; flex-wrap: wrap; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); flex: 1; margin: 10px; min-width: 150px; border-top: 4px solid #3498db; }
        .stat-value { font-size: 2rem; font-weight: bold; color: #2c3e50; margin: 10px 0; }
        .stat-label { color: #7f8c8d; font-size: 0.9rem; }
        @media (max-width: 768px) { .calendar { grid-template-columns: repeat(7, 1fr); } .calendar-day { padding: 8px 2px; min-height: 50px; } .timer { font-size: 3rem; } .user-stats { flex-direction: column; } }
        .sound-control, .vibration-control { display: flex; align-items: center; justify-content: center; margin: 15px 0; }
        .sound-toggle, .vibration-toggle { width: auto; padding: 8px 15px; background: #f1f2f6; color: #2c3e50; margin-left: 10px; }
        .sound-toggle.active, .vibration-toggle.active { background: #3498db; color: white; }
        .month-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .month-selector button { width: auto; padding: 10px 20px; }
        .month-display { font-size: 1.5rem; font-weight: bold; color: #2c3e50; }
        .user-list { margin-top: 20px; }
        .user-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px; background: white; cursor: pointer; }
        .user-item:hover { background-color: #f8f9fa; }
        .delete-user { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .delete-user:hover { background: #c0392b; }
        .user-details { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 5px; }
        .user-detail-view, .group-detail-view { margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: white; }
        .back-button { background: #7f8c8d; margin-bottom: 15px; }
        .back-button:hover { background: #636e72; }
        .timer-status { text-align: center; margin: 10px 0; font-size: 14px; color: #7f8c8d; }
        .background-timer-active { background: linear-gradient(135deg, #ffeaa7, #fab1a0) !important; }
        .group-management { margin-top: 20px; padding: 20px; border: 1px solid #e0e0e0; border-radius: 10px; background: white; }
        .group-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .group-selector button { flex: 1; padding: 10px; background: #f1f2f6; color: #2c3e50; }
        .group-selector button.active { background: #3498db; color: white; }
        .group-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .group-stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05); border-top: 4px solid #3498db; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .group-stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1); }
        .group-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 10px; color: #2c3e50; }
        .user-group-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-group-selector select { width: auto; flex: 1; }
        .date-range-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .date-range-selector input { flex: 1; }
        .date-range-selector button { width: auto; padding: 10px 20px; }
        .total-stats { margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>学习打卡应用</h1>
        
        <div class="section" id="user-section">
            <div class="form-group">
                <label for="user-name">姓名</label>
                <input type="text" id="user-name" placeholder="请输入您的姓名">
            </div>
            <div class="form-group">
                <label for="study-time">学习时长（分钟）</label>
                <input type="number" id="study-time" placeholder="请输入学习时长" min="1" max="480">
            </div>
            
            <div class="sound-control">
                <label for="sound-enabled">学习完成提示音</label>
                <button id="sound-toggle" class="sound-toggle active">开启</button>
            </div>
            
            <div class="vibration-control">
                <label for="vibration-enabled">学习完成振动</label>
                <button id="vibration-toggle" class="vibration-toggle active">开启</button>
            </div>
            
            <button id="start-study">开始学习</button>
            
            <div id="timer-section" class="hidden">
                <div class="timer-status" id="timer-status">计时器运行中...</div>
                <div class="timer" id="timer-display">00:00</div>
                <button id="cancel-study">取消学习</button>
            </div>
        </div>
        
        <div class="section">
            <h2>学习统计</h2>
            
            <div class="date-range-selector">
                <input type="date" id="user-date-start">
                <span>至</span>
                <input type="date" id="user-date-end">
                <button id="user-filter-data">筛选数据</button>
                <button id="user-reset-date">重置</button>
            </div>
            
            <div class="user-stats">
                <div class="stat-card">
                    <div class="stat-label">总学习天数</div>
                    <div class="stat-value" id="total-days">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">总学习时长</div>
                    <div class="stat-value" id="total-hours">0</div>
                    <div class="stat-label">分钟</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">连续学习</div>
                    <div class="stat-value" id="streak-days">0</div>
                    <div class="stat-label">天</div>
                </div>
            </div>
            
            <div id="trend-chart-container">
                <h3>用户学习趋势</h3>
                <div class="chart-container">
                    <canvas id="trend-chart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>学习记录</h2>
            <div class="month-selector">
                <button id="prev-month">上个月</button>
                <div class="month-display" id="current-month">2023年11月</div>
                <button id="next-month">下个月</button>
            </div>
            <div id="calendar-container">
                <div class="calendar-header">
                    <div>日</div>
                    <div>一</div>
                    <div>二</div>
                    <div>三</div>
                    <div>四</div>
                    <div>五</div>
                    <div>六</div>
                </div>
                <div class="calendar" id="calendar"></div>
            </div>
        </div>
        
        <div class="section admin-section">
            <h2>管理员功能</h2>
            <div class="form-group">
                <label for="admin-password">管理员密码</label>
                <input type="password" id="admin-password" placeholder="请输入管理员密码">
            </div>
            <button id="admin-login">管理员登录</button>
            
            <div id="admin-panel" class="hidden">
                <h3>所有用户学习情况</h3>
                <div class="date-range-selector">
                    <input type="date" id="date-start">
                    <span>至</span>
                    <input type="date" id="date-end">
                    <button id="filter-data">筛选数据</button>
                </div>
                
                <div class="total-stats">
                    <h4>总体统计</h4>
                    <div class="user-stats">
                        <div class="stat-card">
                            <div class="stat-label">用户总数量</div>
                            <div class="stat-value" id="total-users">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">总学习时长</div>
                            <div class="stat-value" id="total-study-time">0</div>
                            <div class="stat-label">分钟</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">平均每人学习</div>
                            <div class="stat-value" id="avg-study-time">0</div>
                            <div class="stat-label">分钟</div>
                        </div>
                    </div>
                </div>
                
                <div id="admin-trend-chart-container">
                    <h4>总体学习趋势</h4>
                    <div class="chart-container">
                        <canvas id="admin-trend-chart"></canvas>
                    </div>
                </div>
                
                <div class="group-management">
                    <h4>分组管理</h4>
                    <div class="group-selector">
                        <button id="group-all" class="group-button active" data-group="all">全部</button>
                        <button id="group-children" class="group-button" data-group="儿童班">儿童班</button>
                        <button id="group-youth" class="group-button" data-group="少年班">少年班</button>
                        <button id="group-adult" class="group-button" data-group="成人班">成人班</button>
                        <button id="group-ungrouped" class="group-button" data-group="未分组">未分组</button>
                    </div>
                    <div class="group-stats" id="group-stats"></div>
                    <h5>用户分组管理</h5>
                    <div class="user-list" id="user-list"></div>
                </div>
                
                <div id="user-detail-view" class="user-detail-view hidden">
                    <button id="back-to-user-list" class="back-button">返回用户列表</button>
                    <h4 id="detail-user-name">用户详情</h4>
                    <div class="user-stats">
                        <div class="stat-card">
                            <div class="stat-label">总学习天数</div>
                            <div class="stat-value" id="detail-total-days">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">总学习时长</div>
                            <div class="stat-value" id="detail-total-hours">0</div>
                            <div class="stat-label">分钟</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">连续学习</div>
                            <div class="stat-value" id="detail-streak-days">0</div>
                            <div class="stat-label">天</div>
                        </div>
                    </div>
                    <div class="month-selector">
                        <button id="detail-prev-month">上个月</button>
                        <div class="month-display" id="detail-current-month">2023年11月</div>
                        <button id="detail-next-month">下个月</button>
                    </div>
                    <div class="calendar-header">
                        <div>日</div>
                        <div>一</div>
                        <div>二</div>
                        <div>三</div>
                        <div>四</div>
                        <div>五</div>
                        <div>六</div>
                    </div>
                    <div class="calendar" id="detail-calendar"></div>
                    <h4>用户学习趋势</h4>
                    <div class="chart-container">
                        <canvas id="detail-trend-chart"></canvas>
                    </div>
                </div>
                
                <div id="group-detail-view" class="group-detail-view hidden">
                    <button id="back-to-group-list" class="back-button">返回分组列表</button>
                    <h4 id="detail-group-name">分组详情</h4>
                    <div class="user-stats">
                        <div class="stat-card">
                            <div class="stat-label">用户数量</div>
                            <div class="stat-value" id="detail-group-users">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">总学习时长</div>
                            <div class="stat-value" id="detail-group-total-time">0</div>
                            <div class="stat-label">分钟</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">平均每人学习</div>
                            <div class="stat-value" id="detail-group-avg-time">0</div>
                            <div class="stat-label">分钟</div>
                        </div>
                    </div>
                    <h4>分组学习趋势</h4>
                    <div class="chart-container">
                        <canvas id="group-trend-chart"></canvas>
                    </div>
                </div>

                <button id="admin-logout" style="background: #e74c3c; margin-top: 20px;">退出管理员</button>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">学习完成！打卡成功！</div>

    <script>
        // Supabase配置
        const SUPABASE_URL = 'https://rcpssreclskyhpjvonrk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjcHNzcmVjbHNreWhwanZvbnJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1MTk3NTIsImV4cCI6MjA3NzA5NTc1Mn0.fc7oSuXBwwLieto3CnS4XtWbt17YHkI0da9hbX4TTgo';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // 全局变量
        let timerInterval;
        let remainingTime = 0;
        let currentUser = null;
        let isSoundEnabled = true;
        let isVibrationEnabled = true;
        let studyRecords = [];
        let allUsersData = [];
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let detailCurrentMonth = new Date().getMonth();
        let detailCurrentYear = new Date().getFullYear();
        let selectedUser = null;
        let selectedUserRecords = [];
        let timerEndTime = 0;
        let wakeLock = null;
        let currentGroup = 'all';
        let userGroups = {};
        let selectedGroup = null;
        
        // DOM元素
        const userNameInput = document.getElementById('user-name');
        const studyTimeInput = document.getElementById('study-time');
        const startStudyButton = document.getElementById('start-study');
        const timerSection = document.getElementById('timer-section');
        const timerDisplay = document.getElementById('timer-display');
        const timerStatus = document.getElementById('timer-status');
        const cancelStudyButton = document.getElementById('cancel-study');
        const calendarElement = document.getElementById('calendar');
        const trendChartCanvas = document.getElementById('trend-chart');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginButton = document.getElementById('admin-login');
        const adminPanel = document.getElementById('admin-panel');
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        const filterDataButton = document.getElementById('filter-data');
        const adminTrendChartCanvas = document.getElementById('admin-trend-chart');
        const adminLogoutButton = document.getElementById('admin-logout');
        const notification = document.getElementById('notification');
        const soundToggle = document.getElementById('sound-toggle');
        const vibrationToggle = document.getElementById('vibration-toggle');
        const totalDaysElement = document.getElementById('total-days');
        const totalHoursElement = document.getElementById('total-hours');
        const streakDaysElement = document.getElementById('streak-days');
        const prevMonthButton = document.getElementById('prev-month');
        const nextMonthButton = document.getElementById('next-month');
        const currentMonthDisplay = document.getElementById('current-month');
        const userListElement = document.getElementById('user-list');
        const userDetailView = document.getElementById('user-detail-view');
        const backToUserListButton = document.getElementById('back-to-user-list');
        const detailUserNameElement = document.getElementById('detail-user-name');
        const detailTotalDaysElement = document.getElementById('detail-total-days');
        const detailTotalHoursElement = document.getElementById('detail-total-hours');
        const detailStreakDaysElement = document.getElementById('detail-streak-days');
        const detailCalendarElement = document.getElementById('detail-calendar');
        const detailTrendChartCanvas = document.getElementById('detail-trend-chart');
        const detailPrevMonthButton = document.getElementById('detail-prev-month');
        const detailNextMonthButton = document.getElementById('detail-next-month');
        const detailCurrentMonthDisplay = document.getElementById('detail-current-month');
        const userDateStartInput = document.getElementById('user-date-start');
        const userDateEndInput = document.getElementById('user-date-end');
        const userFilterDataButton = document.getElementById('user-filter-data');
        const userResetDateButton = document.getElementById('user-reset-date');
        const groupButtons = document.querySelectorAll('.group-button');
        const groupStatsElement = document.getElementById('group-stats');
        const totalUsersElement = document.getElementById('total-users');
        const totalStudyTimeElement = document.getElementById('total-study-time');
        const avgStudyTimeElement = document.getElementById('avg-study-time');
        const groupDetailView = document.getElementById('group-detail-view');
        const backToGroupListButton = document.getElementById('back-to-group-list');
        const detailGroupNameElement = document.getElementById('detail-group-name');
        const detailGroupUsersElement = document.getElementById('detail-group-users');
        const detailGroupTotalTimeElement = document.getElementById('detail-group-total-time');
        const detailGroupAvgTimeElement = document.getElementById('detail-group-avg-time');
        const groupTrendChartCanvas = document.getElementById('group-trend-chart');
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            
            dateStartInput.valueAsDate = startDate;
            dateEndInput.valueAsDate = endDate;
            userDateStartInput.valueAsDate = startDate;
            userDateEndInput.valueAsDate = endDate;
            
            startStudyButton.addEventListener('click', startStudy);
            cancelStudyButton.addEventListener('click', cancelStudy);
            adminLoginButton.addEventListener('click', adminLogin);
            filterDataButton.addEventListener('click', loadAdminData);
            adminLogoutButton.addEventListener('click', adminLogout);
            soundToggle.addEventListener('click', toggleSound);
            vibrationToggle.addEventListener('click', toggleVibration);
            prevMonthButton.addEventListener('click', () => changeMonth(-1));
            nextMonthButton.addEventListener('click', () => changeMonth(1));
            backToUserListButton.addEventListener('click', backToUserList);
            detailPrevMonthButton.addEventListener('click', () => changeDetailMonth(-1));
            detailNextMonthButton.addEventListener('click', () => changeDetailMonth(1));
            backToGroupListButton.addEventListener('click', backToGroupList);
            userFilterDataButton.addEventListener('click', loadUserDataWithDateRange);
            userResetDateButton.addEventListener('click', resetUserDateRange);
            
            groupButtons.forEach(button => {
                button.addEventListener('click', function() {
                    groupButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentGroup = this.getAttribute('data-group');
                    loadAdminData();
                });
            });

            const cachedUser = localStorage.getItem('currentUser');
            if (cachedUser) {
                currentUser = cachedUser;
                userNameInput.value = currentUser;
                loadUserData();
            }
            
            checkActiveTimer();
            updateMonthDisplay();
            renderCalendar();
            initTrendChart();
            loadUserGroups();
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('beforeunload', handleBeforeUnload);
        });

        // 函数定义
        async function loadUserGroups() {
            try {
                const { data, error } = await supabase.from('user_groups').select('*');
                if (error) { console.error('加载用户分组失败:', error); return; }
                userGroups = {};
                data.forEach(item => { userGroups[item.user_name] = item.group_name; });
            } catch (error) { console.error('加载用户分组时出错:', error); }
        }
        
        function handleVisibilityChange() {
            if (!document.hidden && timerSection && !timerSection.classList.contains('hidden')) {
                checkTimerStatus();
            }
        }
        
        function handleBeforeUnload() {
            if (timerSection && !timerSection.classList.contains('hidden')) {
                const savedTimer = localStorage.getItem('activeTimer');
                if (savedTimer) {
                    const timerData = JSON.parse(savedTimer);
                    timerData.endTime = timerEndTime;
                    localStorage.setItem('activeTimer', JSON.stringify(timerData));
                }
            }
        }
        
        function checkActiveTimer() {
            const savedTimer = localStorage.getItem('activeTimer');
            if (savedTimer) {
                const timerData = JSON.parse(savedTimer);
                const now = Date.now();
                const endTime = timerData.endTime;
                
                if (endTime > now) {
                    currentUser = timerData.userName;
                    userNameInput.value = currentUser;
                    remainingTime = Math.round((endTime - now) / 1000);
                    timerSection.classList.remove('hidden');
                    startStudyButton.disabled = true;
                    updateTimerDisplay();
                    startTimer(remainingTime);
                    document.getElementById('user-section').classList.add('background-timer-active');
                    timerStatus.textContent = '后台计时器运行中...';
                    showNotification('恢复了之前的学习计时器', 'info');
                } else {
                    handleStudyCompletion();
                    localStorage.removeItem('activeTimer');
                }
            }
        }
        
        function checkTimerStatus() {
            if (timerEndTime > 0) {
                const now = Date.now();
                remainingTime = Math.max(0, Math.round((timerEndTime - now) / 1000));
                if (remainingTime <= 0) { handleStudyCompletion(); } 
                else { updateTimerDisplay(); }
            }
        }
        
        function startStudy() {
            const userName = userNameInput.value.trim();
            const studyTime = parseInt(studyTimeInput.value);
            if (!userName) { showNotification('请输入您的姓名', 'error'); return; }
            if (!studyTime || studyTime <= 0) { showNotification('请输入有效的学习时长', 'error'); return; }
            
            currentUser = userName;
            localStorage.setItem('currentUser', userName);
            timerSection.classList.remove('hidden');
            startStudyButton.disabled = true;
            remainingTime = studyTime * 60;
            updateTimerDisplay();
            timerEndTime = Date.now() + remainingTime * 1000;
            localStorage.setItem('activeTimer', JSON.stringify({
                userName: currentUser,
                studyTime: studyTime,
                endTime: timerEndTime
            }));
            startTimer(remainingTime);
            requestWakeLock();
            document.getElementById('user-section').classList.add('background-timer-active');
            timerStatus.textContent = '计时器运行中（支持后台运行）...';
            showNotification('学习计时器已开始，支持后台运行和息屏计时', 'success');
        }
        
        function startTimer(duration) {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                const now = Date.now();
                remainingTime = Math.max(0, Math.round((timerEndTime - now) / 1000));
                updateTimerDisplay();
                if (remainingTime <= 0) {
                    clearInterval(timerInterval);
                    handleStudyCompletion();
                }
            }, 1000);
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => console.log('屏幕唤醒锁已释放'));
                }
            } catch (err) { console.log('无法获取屏幕唤醒锁:', err.message); }
        }
        
        function releaseWakeLock() {
            if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
        }
        
        function cancelStudy() {
            if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
            timerSection.classList.add('hidden');
            startStudyButton.disabled = false;
            localStorage.removeItem('activeTimer');
            releaseWakeLock();
            document.getElementById('user-section').classList.remove('background-timer-active');
            showNotification('已取消学习', 'info');
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingTime / 60);
            const seconds = remainingTime % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (remainingTime <= 10) {
                timerDisplay.style.color = '#e74c3c';
                timerDisplay.style.transform = 'scale(1.1)';
            } else {
                timerDisplay.style.color = '#e74c3c';
                timerDisplay.style.transform = 'scale(1)';
            }
        }
        
        async function handleStudyCompletion() {
            const savedTimer = localStorage.getItem('activeTimer');
            let studyTime = 0;
            if (savedTimer) {
                const timerData = JSON.parse(savedTimer);
                studyTime = timerData.studyTime;
            }
            const today = new Date().toISOString().split('T')[0];
            try {
                const { data, error } = await supabase.from('study_records').insert([
                    { user_name: currentUser, date: today, study_minutes: studyTime }
                ]);
                if (error) { console.error('保存失败:', error); showNotification('保存失败，请重试', 'error'); return; }
                if (isSoundEnabled) playCompletionSound();
                if (isVibrationEnabled && 'vibrate' in navigator) navigator.vibrate([200, 100, 200, 100, 200]);
                showNotification('学习完成！打卡成功！', 'success');
                await loadUserData();
            } catch (error) { console.error('保存出错:', error); showNotification('网络错误', 'error'); }
            
            setTimeout(function() {
                if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
                timerSection.classList.add('hidden');
                startStudyButton.disabled = false;
                timerDisplay.style.color = '#e74c3c';
                timerDisplay.style.transform = 'scale(1)';
                localStorage.removeItem('activeTimer');
                releaseWakeLock();
                document.getElementById('user-section').classList.remove('background-timer-active');
            }, 3000);
        }
        
        function playCompletionSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                const audioContext = new AudioContext();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.1;
                const beep = () => {
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.2);
                };
                for (let i = 0; i < 5; i++) setTimeout(beep, i * 500);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 3);
            } catch (error) { console.error('无法播放提示音:', error); }
        }
        
        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            soundToggle.textContent = isSoundEnabled ? '开启' : '关闭';
            isSoundEnabled ? soundToggle.classList.add('active') : soundToggle.classList.remove('active');
        }
        
        function toggleVibration() {
            isVibrationEnabled = !isVibrationEnabled;
            vibrationToggle.textContent = isVibrationEnabled ? '开启' : '关闭';
            isVibrationEnabled ? vibrationToggle.classList.add('active') : vibrationToggle.classList.remove('active');
        }
        
        async function loadUserDataWithDateRange() {
            const startDate = userDateStartInput.value;
            const endDate = userDateEndInput.value;
            if (!currentUser) return;
            try {
                let query = supabase.from('study_records').select('*').eq('user_name', currentUser);
                if (startDate && endDate) query = query.gte('date', startDate).lte('date', endDate);
                const { data, error } = await query.order('date', { ascending: true });
                if (error) { console.error('获取失败:', error); showNotification('获取学习记录失败', 'error'); return; }
                studyRecords = data || [];
                updateUserStats();
                renderCalendar();
                updateTrendChart();
            } catch (error) { console.error('出错:', error); showNotification('网络错误', 'error'); }
        }
        
        function resetUserDateRange() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30);
            userDateStartInput.valueAsDate = startDate;
            userDateEndInput.valueAsDate = endDate;
            loadUserDataWithDateRange();
        }
        
        async function loadUserData() { await loadUserDataWithDateRange(); }
        
        function updateUserStats() {
            const userRecords = studyRecords || [];
            const uniqueDates = [...new Set(userRecords.map(record => record.date))];
            totalDaysElement.textContent = uniqueDates.length;
            totalHoursElement.textContent = userRecords.reduce((sum, record) => sum + record.study_minutes, 0);
            streakDaysElement.textContent = calculateStreak(userRecords);
        }
        
        function calculateStreak(records) {
            if (records.length === 0) return 0;
            const uniqueDates = [...new Set(records.map(r => r.date))];
            const dateTimestamps = uniqueDates.map(dateStr => {
                const parts = dateStr.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]).getTime();
            });
            dateTimestamps.sort((a, b) => b - a);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayTimestamp = today.getTime();
            
            const learnedToday = dateTimestamps.some(timestamp => timestamp === todayTimestamp);
            let streak = 0;
            let currentDate = new Date(today);
            
            if (learnedToday) {
                streak = 1;
                currentDate.setDate(currentDate.getDate() - 1);
            } else {
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            while (dateTimestamps.includes(currentDate.getTime())) {
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }
            return streak;
        }
        
        function changeMonth(direction) {
            currentMonth += direction;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            else if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            updateMonthDisplay();
            renderCalendar();
        }
        
        function updateMonthDisplay() {
            currentMonthDisplay.textContent = `${currentYear}年${currentMonth + 1}月`;
        }
        
        function renderCalendar() {
            calendarElement.innerHTML = '';
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendarElement.appendChild(emptyDay);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                const dateStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                if (studyRecords && studyRecords.length > 0) {
                    const hasRecord = studyRecords.some(record => record.date === dateStr);
                    if (hasRecord) {
                        dayElement.classList.add('checked');
                        dayElement.innerHTML = `<div class="calendar-date">${day}</div><div class="calendar-check">✓</div>`;
                    } else { dayElement.innerHTML = `<div class="calendar-date">${day}</div>`; }
                } else { dayElement.innerHTML = `<div class="calendar-date">${day}</div>`; }
                calendarElement.appendChild(dayElement);
            }
        }
        
        function initTrendChart() {
            const ctx = trendChartCanvas.getContext('2d');
            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: '每日学习时长（分钟）', data: [], borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
            });
        }
        
        function updateTrendChart() {
            if (!studyRecords || studyRecords.length === 0) {
                const labels = [];
                const data = [];
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 13);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // 修改日期格式为 年/月/日
                    const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                    labels.push(dateStr);
                    data.push(0);
                }
                window.trendChart.data.labels = labels;
                window.trendChart.data.datasets[0].data = data;
                window.trendChart.update();
                return;
            }
            const dailyStudy = {};
            studyRecords.forEach(record => {
                if (dailyStudy[record.date]) { dailyStudy[record.date] += record.study_minutes; }
                else { dailyStudy[record.date] = record.study_minutes; }
            });
            const allDates = Object.keys(dailyStudy);
            if (allDates.length === 0) return;
            allDates.sort((a, b) => new Date(a) - new Date(b));
            const startDate = new Date(allDates[0]);
            const endDate = new Date(allDates[allDates.length - 1]);
            const dateArray = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateArray.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            // 修改日期格式为 年/月/日
            const labels = dateArray.map(date => {
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });
            const data = dateArray.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                return dailyStudy[dateStr] || 0;
            });
            window.trendChart.data.labels = labels;
            window.trendChart.data.datasets[0].data = data;
            window.trendChart.update();
        }
        
        function adminLogin() {
            const password = adminPasswordInput.value;
            if (password === '000000') {
                adminPanel.classList.remove('hidden');
                adminPasswordInput.value = '';
                loadAdminData();
                showNotification('管理员登录成功', 'success');
            } else { showNotification('密码错误', 'error'); }
        }
        
        function adminLogout() {
            adminPanel.classList.add('hidden');
            userDetailView.classList.add('hidden');
            groupDetailView.classList.add('hidden');
            showNotification('已退出管理员模式', 'info');
        }
        
        async function loadAdminData() {
            const startDate = dateStartInput.value;
            const endDate = dateEndInput.value;
            try {
                let query = supabase.from('study_records').select('*');
                if (startDate && endDate) query = query.gte('date', startDate).lte('date', endDate);
                const { data, error } = await query.order('date', { ascending: true });
                if (error) { console.error('获取失败:', error); showNotification('获取数据失败', 'error'); return; }
                allUsersData = data || [];
                updateTotalStats();
                displayGroupStats();
                displayUserList();
                updateAdminTrendChart(startDate, endDate);
            } catch (error) { console.error('出错:', error); showNotification('网络错误', 'error'); }
        }
        
        function updateTotalStats() {
            const users = [...new Set(allUsersData.map(record => record.user_name))];
            const userCount = users.length;
            const totalMinutes = allUsersData.reduce((sum, record) => sum + record.study_minutes, 0);
            const avgMinutes = userCount > 0 ? Math.round(totalMinutes / userCount) : 0;
            totalUsersElement.textContent = userCount;
            totalStudyTimeElement.textContent = totalMinutes;
            avgStudyTimeElement.textContent = avgMinutes;
        }
        
        function displayGroupStats() {
            const groups = {
                '儿童班': { users: new Set(), totalMinutes: 0, totalDays: 0 },
                '少年班': { users: new Set(), totalMinutes: 0, totalDays: 0 },
                '成人班': { users: new Set(), totalMinutes: 0, totalDays: 0 },
                '未分组': { users: new Set(), totalMinutes: 0, totalDays: 0 }
            };
            const allUsers = [...new Set(allUsersData.map(record => record.user_name))];
            allUsersData.forEach(record => {
                const userGroup = userGroups[record.user_name] || '未分组';
                groups[userGroup].users.add(record.user_name);
                groups[userGroup].totalMinutes += record.study_minutes;
            });
            Object.keys(groups).forEach(group => {
                const groupUsers = Array.from(groups[group].users);
                const userDates = new Set();
                allUsersData.forEach(record => {
                    if (groupUsers.includes(record.user_name)) { userDates.add(record.date); }
                });
                groups[group].totalDays = userDates.size;
            });
            groupStatsElement.innerHTML = '';
            Object.keys(groups).forEach(group => {
                const groupData = groups[group];
                const userCount = groupData.users.size;
                const totalMinutes = groupData.totalMinutes;
                const totalDays = groupData.totalDays;
                const avgMinutes = userCount > 0 ? Math.round(totalMinutes / userCount) : 0;
                const groupCard = document.createElement('div');
                groupCard.className = 'group-stat-card';
                groupCard.setAttribute('data-group', group);
                groupCard.innerHTML = `
                    <div class="group-name">${group}</div>
                    <div class="stat-label">用户数量: ${userCount}</div>
                    <div class="stat-label">总学习天数: ${totalDays}</div>
                    <div class="stat-label">总学习时长: ${totalMinutes} 分钟</div>
                    <div class="stat-label">平均每人: ${avgMinutes} 分钟</div>
                `;
                groupCard.addEventListener('click', function() { showGroupDetail(this.getAttribute('data-group')); });
                groupStatsElement.appendChild(groupCard);
            });
        }
        
        function showGroupDetail(groupName) {
            selectedGroup = groupName;
            detailGroupNameElement.textContent = `${groupName} 详情`;
            let groupUsers = [];
            if (groupName === '未分组') {
                const allUsers = [...new Set(allUsersData.map(record => record.user_name))];
                groupUsers = allUsers.filter(user => !userGroups[user]);
            } else {
                groupUsers = Object.keys(userGroups).filter(user => userGroups[user] === groupName);
            }
            const groupRecords = allUsersData.filter(record => groupUsers.includes(record.user_name));
            updateGroupDetailStats(groupUsers, groupRecords);
            updateGroupTrendChart(groupRecords);
            document.querySelector('.group-management').style.display = 'none';
            groupDetailView.classList.remove('hidden');
        }
        
        function updateGroupDetailStats(users, records) {
            const userCount = users.length;
            const totalMinutes = records.reduce((sum, record) => sum + record.study_minutes, 0);
            const avgMinutes = userCount > 0 ? Math.round(totalMinutes / userCount) : 0;
            detailGroupUsersElement.textContent = userCount;
            detailGroupTotalTimeElement.textContent = totalMinutes;
            detailGroupAvgTimeElement.textContent = avgMinutes;
        }
        
        function updateGroupTrendChart(records) {
            const ctx = groupTrendChartCanvas.getContext('2d');
            if (window.groupTrendChart) { window.groupTrendChart.destroy(); }
            if (!records || records.length === 0) {
                const labels = [];
                const data = [];
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 13);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // 修改日期格式为 年/月/日
                    const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                    labels.push(dateStr);
                    data.push(0);
                }
                window.groupTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: '分组每日学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
                });
                return;
            }
            const dailyStudy = {};
            records.forEach(record => {
                if (dailyStudy[record.date]) { dailyStudy[record.date] += record.study_minutes; }
                else { dailyStudy[record.date] = record.study_minutes; }
            });
            const allDates = Object.keys(dailyStudy);
            if (allDates.length === 0) return;
            allDates.sort((a, b) => new Date(a) - new Date(b));
            const startDate = new Date(allDates[0]);
            const endDate = new Date(allDates[allDates.length - 1]);
            const dateArray = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateArray.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            // 修改日期格式为 年/月/日
            const labels = dateArray.map(date => {
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });
            const data = dateArray.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                return dailyStudy[dateStr] || 0;
            });
            window.groupTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '分组每日学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
            });
        }
        
        function backToGroupList() {
            groupDetailView.classList.add('hidden');
            document.querySelector('.group-management').style.display = 'block';
        }
        
        function displayUserList() {
            let users = [...new Set(allUsersData.map(record => record.user_name))];
            if (currentGroup === '未分组') { users = users.filter(user => !userGroups[user]); }
            else if (currentGroup !== 'all') { users = users.filter(user => userGroups[user] === currentGroup); }
            
            userListElement.innerHTML = '<h5>用户列表</h5>';
            if (users.length === 0) { userListElement.innerHTML += '<p>暂无用户数据</p>'; return; }
            
            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                const userRecords = allUsersData.filter(record => record.user_name === user);
                const uniqueDates = [...new Set(userRecords.map(record => record.date))];
                const totalDays = uniqueDates.length;
                const totalMinutes = userRecords.reduce((sum, record) => sum + record.study_minutes, 0);
                const currentUserGroup = userGroups[user] || '未分组';
                userItem.innerHTML = `
                    <div><strong>${user}</strong><div class="user-details">学习天数: ${totalDays}天 | 总时长: ${totalMinutes}分钟</div></div>
                    <div class="user-group-selector">
                        <select class="group-select" data-user="${user}">
                            <option value="未分组" ${currentUserGroup === '未分组' ? 'selected' : ''}>未分组</option>
                            <option value="儿童班" ${currentUserGroup === '儿童班' ? 'selected' : ''}>儿童班</option>
                            <option value="少年班" ${currentUserGroup === '少年班' ? 'selected' : ''}>少年班</option>
                            <option value="成人班" ${currentUserGroup === '成人班' ? 'selected' : ''}>成人班</option>
                        </select>
                        <button class="delete-user" data-user="${user}">删除用户</button>
                    </div>`;
                userListElement.appendChild(userItem);
                const groupSelect = userItem.querySelector('.group-select');
                groupSelect.addEventListener('change', function() { updateUserGroup(this.getAttribute('data-user'), this.value); });
                userItem.addEventListener('click', function(e) {
                    if (!e.target.classList.contains('delete-user') && !e.target.classList.contains('group-select')) { showUserDetail(user); }
                });
            });
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function(e) { e.stopPropagation(); deleteUser(this.getAttribute('data-user')); });
            });
        }
        
        async function updateUserGroup(userName, group) {
            try {
                const { error } = await supabase.from('user_groups').upsert({ user_name: userName, group_name: group }, { onConflict: 'user_name' });
                if (error) { console.error('更新失败:', error); showNotification('更新分组失败', 'error'); return; }
                userGroups[userName] = group;
                showNotification(`已将用户 ${userName} 分配到 ${group}`, 'success');
                loadAdminData();
            } catch (error) { console.error('出错:', error); showNotification('网络错误', 'error'); }
        }
        
        async function showUserDetail(userName) {
            selectedUser = userName;
            detailUserNameElement.textContent = `${userName} 的学习详情`;
            try {
                const { data, error } = await supabase.from('study_records').select('*').eq('user_name', userName).order('date', { ascending: true });
                if (error) { console.error('获取失败:', error); showNotification('获取用户学习记录失败', 'error'); return; }
                selectedUserRecords = data || [];
                updateUserDetailStats();
                renderDetailCalendar();
                updateDetailTrendChart();
                document.querySelector('.group-management').style.display = 'none';
                userDetailView.classList.remove('hidden');
            } catch (error) { console.error('出错:', error); showNotification('网络错误', 'error'); }
        }
        
        function updateUserDetailStats() {
            const userRecords = selectedUserRecords || [];
            const uniqueDates = [...new Set(userRecords.map(record => record.date))];
            detailTotalDaysElement.textContent = uniqueDates.length;
            detailTotalHoursElement.textContent = userRecords.reduce((sum, record) => sum + record.study_minutes, 0);
            detailStreakDaysElement.textContent = calculateStreak(userRecords);
        }
        
        function changeDetailMonth(direction) {
            detailCurrentMonth += direction;
            if (detailCurrentMonth < 0) { detailCurrentMonth = 11; detailCurrentYear--; }
            else if (detailCurrentMonth > 11) { detailCurrentMonth = 0; detailCurrentYear++; }
            updateDetailMonthDisplay();
            renderDetailCalendar();
        }
        
        function updateDetailMonthDisplay() {
            detailCurrentMonthDisplay.textContent = `${detailCurrentYear}年${detailCurrentMonth + 1}月`;
        }
        
        function renderDetailCalendar() {
            detailCalendarElement.innerHTML = '';
            const firstDay = new Date(detailCurrentYear, detailCurrentMonth, 1).getDay();
            const daysInMonth = new Date(detailCurrentYear, detailCurrentMonth + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                detailCalendarElement.appendChild(emptyDay);
            }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                const dateStr = `${detailCurrentYear}-${(detailCurrentMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                if (selectedUserRecords && selectedUserRecords.length > 0) {
                    const hasRecord = selectedUserRecords.some(record => record.date === dateStr);
                    if (hasRecord) {
                        dayElement.classList.add('checked');
                        dayElement.innerHTML = `<div class="calendar-date">${day}</div><div class="calendar-check">✓</div>`;
                    } else { dayElement.innerHTML = `<div class="calendar-date">${day}</div>`; }
                } else { dayElement.innerHTML = `<div class="calendar-date">${day}</div>`; }
                detailCalendarElement.appendChild(dayElement);
            }
        }
        
        function updateDetailTrendChart() {
            const ctx = detailTrendChartCanvas.getContext('2d');
            if (window.detailTrendChart) { window.detailTrendChart.destroy(); }
            if (!selectedUserRecords || selectedUserRecords.length === 0) {
                const labels = [];
                const data = [];
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 13);
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    // 修改日期格式为 年/月/日
                    const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                    labels.push(dateStr);
                    data.push(0);
                }
                window.detailTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: '每日学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
                });
                return;
            }
            const dailyStudy = {};
            selectedUserRecords.forEach(record => {
                if (dailyStudy[record.date]) { dailyStudy[record.date] += record.study_minutes; }
                else { dailyStudy[record.date] = record.study_minutes; }
            });
            const allDates = Object.keys(dailyStudy);
            if (allDates.length === 0) return;
            allDates.sort((a, b) => new Date(a) - new Date(b));
            const startDate = new Date(allDates[0]);
            const endDate = new Date(allDates[allDates.length - 1]);
            const dateArray = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                dateArray.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            // 修改日期格式为 年/月/日
            const labels = dateArray.map(date => {
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });
            const data = dateArray.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                return dailyStudy[dateStr] || 0;
            });
            window.detailTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '每日学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
            });
        }
        
        function backToUserList() {
            userDetailView.classList.add('hidden');
            document.querySelector('.group-management').style.display = 'block';
        }
        
        async function deleteUser(userName) {
            if (!confirm(`确定要删除用户 "${userName}" 的所有学习记录吗？此操作不可撤销。`)) return;
            try {
                const { error: recordError } = await supabase.from('study_records').delete().eq('user_name', userName);
                if (recordError) { console.error('删除记录失败:', recordError); showNotification('删除失败', 'error'); return; }
                const { error: groupError } = await supabase.from('user_groups').delete().eq('user_name', userName);
                if (groupError) { console.error('删除分组失败:', groupError); }
                delete userGroups[userName];
                showNotification(`已删除用户 "${userName}"`, 'success');
                loadAdminData();
            } catch (error) { console.error('出错:', error); showNotification('网络错误', 'error'); }
        }
        
        function updateAdminTrendChart(startDate, endDate) {
            const ctx = adminTrendChartCanvas.getContext('2d');
            if (window.adminTrendChart) { window.adminTrendChart.destroy(); }
            if (!allUsersData || allUsersData.length === 0) {
                const labels = [];
                const data = [];
                const end = new Date();
                const start = new Date();
                start.setDate(start.getDate() - 13);
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    // 修改日期格式为 年/月/日
                    const dateStr = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
                    labels.push(dateStr);
                    data.push(0);
                }
                window.adminTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: '所有用户总学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
                });
                return;
            }
            const dailyData = {};
            allUsersData.forEach(record => {
                if (!dailyData[record.date]) { dailyData[record.date] = 0; }
                dailyData[record.date] += record.study_minutes;
            });
            let start = startDate ? new Date(startDate) : new Date();
            let end = endDate ? new Date(endDate) : new Date();
            if (!startDate && !endDate) { start = new Date(); start.setDate(start.getDate() - 13); }
            const dateArray = [];
            const currentDate = new Date(start);
            while (currentDate <= end) {
                dateArray.push(new Date(currentDate));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            // 修改日期格式为 年/月/日
            const labels = dateArray.map(date => {
                return `${date.getFullYear()}/${date.getMonth() + 1}/${date.getDate()}`;
            });
            const data = dateArray.map(date => {
                const dateStr = date.toISOString().split('T')[0];
                return dailyData[dateStr] || 0;
            });
            window.adminTrendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: '所有用户总学习时长（分钟）', data: data, borderColor: '#9b59b6', backgroundColor: 'rgba(155, 89, 182, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: '学习时长（分钟）' } }, x: { title: { display: true, text: '日期' } } }, plugins: { tooltip: { callbacks: { label: function(context) { return `学习时长: ${context.parsed.y} 分钟`; } } } } }
            });
        }
        
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            if (type === 'error') { notification.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)'; }
            else if (type === 'info') { notification.style.background = 'linear-gradient(135deg, #3498db, #2980b9)'; }
            else { notification.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)'; }
            notification.classList.add('show');
            setTimeout(() => { notification.classList.remove('show'); }, 3000);
        }
    </script>
</body>
</html>
